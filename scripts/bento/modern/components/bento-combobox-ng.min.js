/**
 * Bento Modern v0.8.13
 * Copyright 2015 Thomson Reuters
 * Maintained by Chi Gao, Joe Huang, Aaron Mendez
 */
!function(a){"use strict";var b=a.module("bento.combobox",["ngSanitize","bento.services"]);b.constant("COMBOBOX_SERVER_TIMEOUT",1e4).constant("COMBOBOX_PAGE_UP",-1).constant("COMBOBOX_PAGE_DOWN",1).controller("bentoComboboxControl",["$scope","$element","$timeout","$attrs","$bentoServices","$log","COMBOBOX_SERVER_TIMEOUT","COMBOBOX_PAGE_UP","COMBOBOX_PAGE_DOWN",function(b,c,d,e,f,g,h,i,j,k){function l(){if(!b.searchable)return!0;if(b.baseData)for(var a=b.inputLabel.trim(),c=0;c<b.baseData.length;c++){var d=b.baseData[c],e=d[b.labelName];if("string"==typeof e){if(d[b.labelName]===a)return!0}else for(var f=0;f<e.length;f++)if(e[f]&&e[f]===a)return!0}return!1}function m(a){var c,d=b.bentoContainerProperties.containerBody,e=d.getElementsByClassName("bento-combobox-container-item"),f=d.offsetHeight,g=e[0].offsetHeight;return d.scrollTop<f&&a===j?(b.currentSelectedIndex=0,void b.selectItem(b.currentSelectedIndex,!0)):d.scrollTop+2*f>d.scrollHeight&&a===k&&!b.useServer?(b.currentSelectedIndex=b.data.length-1,void b.selectItem(b.currentSelectedIndex,!0)):(d.scrollTop=d.scrollTop+a*f,c=Math.floor(a===k?d.scrollTop/g:(d.scrollTop+f)/g),void("undefined"==typeof e[c]||n(e[c],d.scrollTop,f)||(b.currentSelectedIndex=c,b.selectItem(b.currentSelectedIndex,!0))))}function n(a,b,c){return a.offsetTop<b||a.offsetTop+a.offsetHeight>b+c?!1:!0}function o(){C.click||(y=!0,window.addEventListener("click",r),C.click=r)}function p(){l()||(e.selectedIndex&&(b.selectedIndex=-1),b.currentSelectedIndex=-1,b.onChange({index:-1})),-1===b.currentSelectedIndex&&(b.inputLabel="",b.inputLabelPreview=b.placeholder?b.placeholder:"",b.useServer?b.onPageRequest&&(c.addClass("loading"),b.onPageRequest({searchString:"",page:0}),b.timeoutDigest(),x=!0):b.data=b.baseData)}function q(){window.removeEventListener("click",r),C.click=null,y=!1,f.safeApply(b)}function r(a){c[0].contains(a.target)||(b.isContainerVisible&&(b.isContainerVisible=!1,f.safeApply(b)),p(),q())}var s,t,u,v=0,w=!1,x=!1,y=!1,z=!0,A=500,B=0,C={};if(b.isTableDropdown=!!b.headers()&&b.headers().length>0,b.isContainerVisible=!1,b.inputLabel="",b.currentSelectedIndex=-1,b.usingArrowKey=!1,b.data=[],b.bentoContainerProperties={containerHeader:null,containerBody:null,containerItem:null},c.addClass("form-control"),c[0].className.trim().length>0&&(b.inputClasses=c[0].className),b.arrowDirection="down",c.hasClass("up")&&(b.arrowDirection="up"),b.placeholder&&(b.inputLabelPreview=b.placeholder,b.$watch("placeholder",function(){b.inputLabelPreview=b.placeholder})),this.getIsTableDropdown=function(){return b.isTableDropdown},this.getIsContainerVisible=function(){return b.isContainerVisible},this.getBentoContainerProperties=function(){return b.bentoContainerProperties},b.onInputFocus=function(){c.addClass("in-focus"),t=0,u=!1},b.onInputBlur=function(){c.removeClass("in-focus")},b.$watchCollection("baseData",function(){if(!b.baseData||0===b.baseData.length)return void(b.data=b.baseData);if(b.data=b.baseData,z&&e.selectedIndex&&b.selectedIndex>-1){var a=b.data[b.selectedIndex];b.inputLabel="string"==typeof a[b.labelName]?a[b.labelName]:a[0]}z=!1,w=!0,B=0,clearTimeout(v),c.removeClass("loading"),b.isTableDropdown&&b.alignHeaders()}),e.selectedIndex&&b.$watch("selectedIndex",function(a){b.selectItem(a)?b.currentSelectedIndex=a:(b.inputValue="",b.inputLabel="",b.inputLabelPreview=b.placeholder?b.placeholder:"",b.currentSelectedIndex=-1,b.useServer&&0===b.inputLabel.trim().length&&x&&(x=!1,b.onPageRequest&&(b.currentLoadedPageIndex=0,b.onPageRequest({page:b.currentLoadedPageIndex,searchString:""}))))}),b.isTableDropdown){b.$watch("isContainerVisible",function(a){a&&b.alignHeaders()});var D,E;"undefined"==typeof C.resize&&(window.addEventListener("resize",function(){var a=b.bentoContainerProperties.containerItem;if("undefined"!=typeof a&&null!==a){"undefined"==typeof D&&(D=b.bentoContainerProperties.containerHeader.children,E=a.children);for(var c=0;c<D.length;c++)c<D.length-1&&(D[c].style.width=c+1===D.length?E[c].offsetWidth-20+"px":E[c].offsetWidth+"px")}}),C.resize=!0)}b.useServer&&(b.bentoContainerProperties.containerBody||(b.bentoContainerProperties.containerBody=c[0].querySelector(".bento-combobox-container-body")),b.containerBody=b.bentoContainerProperties.containerBody,b.containerList=b.containerBody.firstElementChild,b.currentLoadedPageIndex=0,"undefined"==typeof C.scroll&&(b.containerBody.addEventListener("scroll",function(){b.containerList.offsetHeight-b.containerBody.offsetHeight-b.containerBody.scrollTop<1e3&&w&&(w=!1,b.onPageRequest&&(b.currentLoadedPageIndex++,b.onPageRequest({page:b.currentLoadedPageIndex,searchString:b.usingArrowKey&&!x?"":b.inputLabel.trim()})),b.timeoutDigest())}),C.scroll=!0)),b.onItemClick=function(c){var d=b.data[c],f=b.baseData.indexOf(d);return a.equals(s,d)&&b.selectedIndex===f?void(b.isContainerVisible=!1):(s=d,e.selectedIndex?f===b.selectedIndex?(b.currentSelectedIndex=f,b.selectItem(f)):b.selectedIndex=f:(b.currentSelectedIndex=c,b.selectItem(c)),void(b.isContainerVisible=!1))},b.onInputKeydown=function(a){if(40===a.keyCode)b.data.length>0&&(b.currentSelectedIndex=(b.currentSelectedIndex+1)%b.data.length,b.selectItem(b.currentSelectedIndex,!0)),b.isContainerVisible=!0,b.usingArrowKey=!0,a.preventDefault(),a.stopPropagation();else if(38===a.keyCode)b.data.length>0&&(b.currentSelectedIndex=-1===b.currentSelectedIndex?b.data.length-1:(b.currentSelectedIndex+b.data.length-1)%b.data.length,b.selectItem(b.currentSelectedIndex,!0)),b.isContainerVisible=!0,b.usingArrowKey=!0,a.preventDefault(),a.stopPropagation();else if(13===a.keyCode)b.isContainerVisible=!b.isContainerVisible,b.usingArrowKey=!0,0===b.inputLabel.trim().length&&-1===b.currentSelectedIndex&&(e.selectedIndex&&(b.selectedIndex=-1),!b.isContainerVisible&&b.onChange&&b.onChange({index:-1})),a.preventDefault(),a.stopPropagation();else if(9===a.keyCode)b.currentSelectedIndex>-1?e.selectedIndex?b.selectedIndex=b.baseData.indexOf(b.data[b.currentSelectedIndex]):b.selectItem(b.currentSelectedIndex,!1):p(),b.usingArrowKey=!0,b.isContainerVisible=!1;else if(27===a.keyCode)b.isContainerVisible=!1;else if(a.keyCode>32&&a.keyCode<37){var d=c.children()[0];switch(a.keyCode){case 33:if(b.currentSelectedIndex<=0){b.currentSelectedIndex=0,b.selectItem(b.currentSelectedIndex,!0);break}m(j);break;case 34:if(b.currentSelectedIndex===b.data.length-1)break;m(k);break;case 35:if(a.shiftKey)break;b.currentSelectedIndex=b.data.length-1,b.selectItem(b.currentSelectedIndex,!0),d.setSelectionRange(b.inputLabel.length,b.inputLabel.length);break;case 36:if(a.shiftKey)break;b.currentSelectedIndex=0,b.selectItem(b.currentSelectedIndex,!0),d.setSelectionRange(0,0)}b.isContainerVisible=!0,b.usingArrowKey=!0,a.shiftKey||(a.preventDefault(),a.stopPropagation())}},b.onInputKeyup=function(a){0===b.inputLabel.trim().length&&x&&(x=!1,b.onPageRequest&&(b.currentLoadedPageIndex=0,b.onPageRequest({page:b.currentLoadedPageIndex,searchString:""}))),13===a.keyCode?b.currentSelectedIndex>-1&&(t>32&&37>t||38===t||40===t)&&!u&&b.onItemClick(b.currentSelectedIndex):b.searchable&&(f.isPrintableKeyCode(a.keyCode)||8===a.keyCode||46===a.keyCode)&&(b.usingArrowKey=!1,b.isContainerVisible=!0,b.currentSelectedIndex=-1,b.searchAndAddData(b.inputLabel),b.alignHeaders()),8!==a.keyCode&&46!==a.keyCode||0!==b.inputLabel.trim().length||(e.selectedIndex?b.selectedIndex=-1:b.currentSelectedIndex=-1),b.isContainerVisible&&o(),t=a.keyCode,u=a.shiftKey,a.preventDefault(),a.stopPropagation()},b.onDownArrowClick=function(a,e){if(!b.disabled){"INPUT"===e.currentTarget.tagName&&b.ignoreInputClick||(b.isContainerVisible=!b.isContainerVisible,b.$emit("append_to_parent_show_list",b.isContainerVisible),b.isContainerVisible&&o());var f=c.children()[0];d(function(){b.searchable&&b.isContainerVisible&&(a?f.setSelectionRange(0,f.value.length):f.focus()),b.isContainerVisible&&b.findAndShowSelectedItem()})}},b.selectItem=function(a,c){if("undefined"==typeof b.data||0>a||"undefined"==typeof a||null===a)return!1;var e=b.baseData[a][b.labelName];return c?b.inputLabelPreview="string"!=typeof e?e[0]:e:(b.inputLabel="string"!=typeof e?e[0]:e,b.inputValue=b.baseData[a][b.valueName],b.onChange&&b.onChange({value:b.inputValue,label:b.inputLabel,item:b.baseData[a],index:a}),b.resetListOnSelect()&&(x=!1,b.useServer?(b.currentLoadedPageIndex=0,b.onPageRequest({page:b.currentLoadedPageIndex,searchString:""})):b.data=b.baseData)),b.ngHide||!b.ngShow&&"undefined"!=typeof b.ngShow||d(b.findAndShowSelectedItem),!0},b.findAndShowSelectedItem=function(){var a=document.querySelector(".bento-combobox-container-list").querySelector(".selected");if(a){var b=a.offsetTop,c=a.offsetHeight,d=a.parentNode.parentNode.offsetHeight,e=a.parentNode.parentNode.scrollTop;b+c>d+e?a.parentNode.parentNode.scrollTop=b+c-d:e>b&&(a.parentNode.parentNode.scrollTop=b)}};var F=b.searchKeydownTimeout||1e3,G=0;b.searchAndAddData=function(a){if(b.currentSelectedIndex=-1,0===a.length)return b.inputLabelPreview=b.placeholder?b.placeholder:"",void(b.data=b.baseData);var d=b.minSearchCharacterCount?b.minSearchCharacterCount:3;b.useServer&&a.trim().length>=d&&(clearTimeout(G),G=setTimeout(function(){b.onPageRequest&&(c.addClass("loading"),b.onPageRequest({searchString:a.trim(),page:b.currentLoadedPageIndex=0}),b.timeoutDigest(),b.containerBody.scrollTop=0,x=!0)},F));var e,f=new RegExp("("+a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","i");if(b.data=[],b.baseData)for(var g=0;g<b.baseData.length;g++){var h=b.baseData[g];if(e=h[b.labelName],"string"==typeof e)-1!==h[b.labelName].search(f)&&b.data.push(h);else for(var i=0;i<e.length;i++)if(e[i]&&-1!==e[i].search(f)){b.data.push(h);break}}},b.timeoutDigest=function(){B++,clearTimeout(v),i>B*A?v=setTimeout(b.timeoutDigest,A):(B=0,c.removeClass("loading"),g.warn("Server timeout: no response for "+Math.round(i/1e3)+" seconds.")),f.safeApply(b)},b.htmlEntities=function(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},b.alignHeaders=function(){d(function(){var c=b.bentoContainerProperties.containerHeader;if(c){var d=b.bentoContainerProperties.containerHeader.children,e=a.element(d),f=b.bentoContainerProperties.containerItem;if(f){var g=f.children;if(g[0].offsetWidth>0){e.removeAttr("style");for(var h=0;h<d.length;h++)h<d.length-1&&(d[h].style.width=h+1===d.length?g[h].offsetWidth-20+"px":g[h].offsetWidth+"px")}else e.css("margin-right","10px")}else e.css("margin-right","10px")}})}}]).directive("bentoCombobox",["$document","$timeout",function(b,c){return{controller:"bentoComboboxControl",scope:{valueName:"@",labelName:"@",placeholder:"@",inputValue:"=ngModel",baseData:"=data",searchable:"=",type:"&",useServer:"=",onPageRequest:"&",onChange:"&",selectedIndex:"=?",disabled:"=",resetListOnSelect:"&",headers:"&",minSearchCharacterCount:"=",ignoreInputClick:"=",ngHide:"=",ngShow:"=",searchKeydownTimeout:"="},templateUrl:"../templates/combobox/bento-combobox.html",transclude:!0,replace:!0,link:function(b,d,e,f,g){g(b,function(b){0===b.text().trim().length&&a.element(d[0].querySelector(".bento-combobox-container-footer")).addClass("ng-hide")}),e.disabled&&!b.disabled&&d.removeAttr("disabled");var h=d.find(".bento-combobox-container");h&&h.addClass("bento-append-to-parent"),c(function(){b.bentoContainerProperties.containerHeader||(b.bentoContainerProperties.containerHeader=d[0].querySelector(".bento-combobox-container-header")),b.bentoContainerProperties.containerBody||(b.bentoContainerProperties.containerBody=d[0].querySelector(".bento-combobox-container-body")),b.bentoContainerProperties.containerItem||(b.bentoContainerProperties.containerItem=d[0].querySelector(".bento-combobox-container-item"))})}}}])}(window.angular);